#SERVER A

#connect to tpm simulator on port 2321
export TPM2TOOLS_TCTI=mssim:host=localhost,port=2321
tpm2_startup -c

#MIGRATE ASSYMETRIC KEY FROM SERVER A TO SERVER B

#take ownership of the tpm
tpm2_clear
tpm2_startup -c
tpm2_changeauth -c owner password
tpm2_changeauth -c endorsement password

#create root object and auth policy that only allows duplication
tpm2_createprimary -C o -P password -g sha256 -G rsa -c primary.ctx
tpm2_startauthsession -S session.dat
tpm2_policycommandcode -S session.dat -L dupPolicy.dat TPM2_CC_Duplicate
tpm2_flushcontext session.dat
rm session.dat

#generate rsa key to be duplicated
tpm2_create -C primary.ctx -g sha256 -G rsa -p password -r key.priv -u key.pub -L dupPolicy.dat -a "sensitivedataorigin|userwithauth|decrypt|sign"
tpm2_flushcontext -t
tpm2_load -C primary.ctx -r key.priv -u key.pub -c key.ctx
tpm2_readpublic -c key.ctx -o dup.pub

#sign and encrypt locally
echo "secret message" > secret.txt
tpm2_flushcontext -t
tpm2_rsaencrypt -c key.ctx -o data.encrypted secret.txt #rename the encrypted file
tpm2_flushcontext -t
tpm2_sign -c key.ctx -g sha256 -p password -o sig.rssa secret.txt

#start an auth session and policy command to allow duplication
tpm2_startauthsession --policy-session -S session.dat
tpm2_policycommandcode -S session.dat -L dupPolicy.dat TPM2_CC_Duplicate

#load the public portion of the parent key from Server B
tpm2_loadexternal -C o -u newParent.pub -c newParent.ctx

#start the duplication
tpm2_flushcontext -t
tpm2_duplicate -C newParent.ctx -c key.ctx -G null -p "session:session.dat" -r dup.dpriv -s dup.seed
